<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>항현이 집들이</title>
  <!-- Fonts: 구글 Noto Sans KR + Inter (깔끔한 토스/구글 느낌) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0c10;
      --card: #14161c;
      --card-2: #191c23;
      --text: #eef2ff;
      --muted: #a6adbb;
      --accent: #7c3aed; /* purple */
      --accent-2: #06b6d4; /* cyan */
      --danger: #ef4444;
      --success: #22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 20px;
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background: radial-gradient(1200px 600px at 80% -10%, rgba(124,58,237,.25), transparent 60%),
                           radial-gradient(1000px 500px at -10% 100%, rgba(6,182,212,.20), transparent 60%),
                           var(--bg);
      color:var(--text);
      font-family: Inter, "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Malgun Gothic", sans-serif;
      letter-spacing: -0.2px;
    }
    .app{ max-width: 780px; margin: 0 auto; padding: 16px 16px 96px; }

    /* Header */
    .header{ position: sticky; top:0; z-index: 20; backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(11,12,16,.85), rgba(11,12,16,.55));
      padding: 14px 16px; margin: -16px -16px 12px; border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; }
    .title{ font-weight: 800; letter-spacing: -0.5px; cursor:pointer; display:flex; align-items:center; gap:10px; }
    .title span{ background: linear-gradient(90deg, var(--accent), var(--accent-2)); -webkit-background-clip: text; background-clip:text; color: transparent; }
    .badge{ font-size: 11px; padding: 4px 8px; border-radius: 999px; background: rgba(124,58,237,.15); color:#d8c8ff; }

    /* Hint */
    .hint{ font-size:12px; color:var(--muted); margin: 0 2px 10px; }

    /* Current Tab label */
    .curtab{ font-size:13px; color:var(--muted); margin: 6px 2px 6px; }

    /* Card */
    .card{ background: linear-gradient(180deg, var(--card), var(--card-2)); border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius); padding:14px; box-shadow: var(--shadow); }

    /* Input Row */
    .row{ display:flex; gap:10px; align-items: stretch; }
    .row.wrap{ flex-wrap: wrap; }
    .row .grow{ flex:1; }
    input[type="text"], input[type="number"], textarea{
      width:100%; background:#0f1117; color:var(--text); border:1px solid rgba(255,255,255,.12);
      padding:14px 12px; border-radius: 14px; outline:none; font-size:15px;
    }
    textarea{ min-height: 88px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color:#8a90a2; }
    .btn{ border:none; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:white; padding:14px 16px; border-radius: 14px; font-weight:800; letter-spacing:.2px; cursor:pointer; box-shadow: 0 6px 20px rgba(124,58,237,.35); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background:#0f1117; border:1px solid rgba(255,255,255,.14); box-shadow:none; font-weight:600; }
    .btn.danger{ background: linear-gradient(135deg, #ef4444, #f97316); box-shadow: 0 6px 20px rgba(239,68,68,.35); }

    /* List */
    .list{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item{ display:flex; flex-direction:column; gap:8px; padding:12px; border:1px solid rgba(255,255,255,.06); border-radius: 14px; background: rgba(255,255,255,.02); }
    .toprow{ display:flex; align-items:center; gap:10px; }
    .item .txt{ flex:1; font-weight:700; }
    .item .desc{ display:none; color:var(--muted); white-space:pre-wrap; line-height:1.5; }
    .item.open .desc{ display:block; }
    .item.clickable{ cursor:pointer; }
    .actions{ display:flex; align-items:center; gap:8px; }
    .heart{ display:flex; gap:6px; align-items:center; border:1px solid rgba(255,255,255,.10); padding:8px 10px; border-radius:12px; cursor:pointer; }
    .heart[data-liked="true"]{ background: rgba(124,58,237,.18); border-color: rgba(124,58,237,.45); }
    .del{ border:1px solid rgba(255,255,255,.10); padding:8px 10px; border-radius:12px; cursor:pointer; }
    .del:hover{ border-color: rgba(255,255,255,.25); }

    /* Top 3 grid */
    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 560px){ .grid{ grid-template-columns: 1fr 1fr; } }

    /* Bottom Tabs */
    .tabs{ position: fixed; bottom: 12px; left: 0; right: 0; z-index: 30; display:flex; justify-content:center; pointer-events:none; }
    .tabs-inner{ pointer-events:auto; display:flex; gap:10px; background: rgba(20,22,28,.85); border:1px solid rgba(255,255,255,.08); padding:8px; border-radius: 20px; backdrop-filter: blur(8px); box-shadow: var(--shadow); }
    .tab{ flex:1; min-width: 72px; text-align:center; padding:10px 12px; border-radius:14px; color:var(--muted); font-weight:700; cursor:pointer; border:1px solid transparent; }
    .tab.active{ color:var(--text); background: rgba(124,58,237,.16); border-color: rgba(124,58,237,.35); }

    /* Modal */
    .modal{ position: fixed; inset:0; display:none; place-items:center; background: rgba(0,0,0,.6); z-index: 50; }
    .modal.open{ display:grid; }
    .paper{ background: radial-gradient(120% 120% at 0% 0%, rgba(124,58,237,.25), rgba(255,255,255,.03)), #0f1117; color:var(--text); border:1px solid rgba(255,255,255,.10); border-radius: 24px; padding: 36px 28px; text-align:center; box-shadow: var(--shadow); }
    .hip{ font-size: clamp(22px, 6vw, 36px); font-weight: 800; letter-spacing: -0.6px; line-height: 1.2; background: linear-gradient(90deg, #22d3ee, #a78bfa, #fb7185, #22d3ee); -webkit-background-clip: text; background-clip:text; color:transparent; animation: move 4s linear infinite; background-size: 300% 100%; }
    @keyframes move{ 0%{ background-position:0% 50%; } 100%{ background-position:100% 50%; } }
    .sub{ color:var(--muted); margin-top:10px; font-size:13px; }

    /* Toast */
    .toast{ position: fixed; bottom: 78px; left:50%; transform: translateX(-50%); background: #111827; color:#e5e7eb; border:1px solid rgba(255,255,255,.10); padding:10px 14px; border-radius:12px; display:none; z-index: 60; box-shadow: var(--shadow); }
    .toast.show{ display:block; }
  </style>
</head>
<body>
  <div class="header">
    <div class="title" id="titleBtn" aria-label="항현이 집들이">
      <span>항현이 집들이</span>
      <div class="badge">Party Mode ✦</div>
    </div>
  </div>

  <div class="app">
    <div class="curtab" id="curTab">현재 탭: 먹거리</div>
    <div class="hint">각 항목을 클릭하면 설명을 볼 수 있습니다.</div>

    <!-- Composer -->
    <div class="card" id="composer">
      <div class="row" style="margin-bottom:10px;">
        <input id="newText" class="grow" type="text" maxlength="72" placeholder="제목 (예: 삼겹살 / 마라탕 / 포커 / 설거지 담당)" />
        <input id="pin" type="number" inputmode="numeric" pattern="\\d{4}" placeholder="4자리" title="4자리 비밀번호" />
        <button class="btn" id="addBtn">등록</button>
      </div>
      <div class="row wrap" style="gap:10px;">
        <textarea id="newDesc" class="grow" placeholder="설명 (선택) — 예: 고기, 쌈채소, 콜라는 내가 사올게! 또는 게임 방식/룰, 할일 상세 등"></textarea>
      </div>
      <div style="font-size:12px; color:var(--muted); margin-top:6px;">항목마다 4자리 비밀번호를 설정합니다. 같은 번호로 해당 항목을 삭제할 수 있어요.</div>
    </div>

    <!-- Lists -->
    <div class="list" id="list"></div>

    <!-- Rank (Top 3) -->
    <div id="rank" style="display:none; margin-top:10px;">
      <div class="grid">
        <div class="card"><h3 style="margin:0 0 8px;">🍽️ 먹거리 Top 3</h3><div id="r-food"></div></div>
        <div class="card"><h3 style="margin:0 0 8px;">🎮 게임 Top 3</h3><div id="r-game"></div></div>
        <div class="card"><h3 style="margin:0 0 8px;">🧽 할일 Top 3</h3><div id="r-todo"></div></div>
      </div>
    </div>
  </div>

  <!-- Bottom Tabs -->
  <div class="tabs">
    <div class="tabs-inner">
      <div class="tab active" data-tab="food">🍽️ 먹거리</div>
      <div class="tab" data-tab="game">🎮 게임</div>
      <div class="tab" data-tab="todo">🧽 할일</div>
      <div class="tab" data-tab="rank">🏆 순위</div>
    </div>
  </div>

  <!-- Hip Modal -->
  <div class="modal" id="hipModal" role="dialog" aria-modal="true">
    <div class="paper">
      <div class="hip">길동꼬추 집들이 레츠기릿</div>
      <div class="sub">화면을 탭하면 닫혀요 ✨</div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase + App Script -->
  <script type="module">
    // === ⚡ Firebase (Firestore + Auth) ===
    // 1) 아래 config에 본인 Firebase 프로젝트 설정을 붙여 넣으세요.
    //    (Firebase 콘솔 → 프로젝트 만들기 → Web App 추가 → SDK 설정에서 복사)
    const firebaseConfig = {
      apiKey: "PASTE_YOUR_API_KEY",
      authDomain: "PASTE_YOUR_AUTH_DOMAIN",
      projectId: "PASTE_YOUR_PROJECT_ID",
      storageBucket: "PASTE_YOUR_STORAGE_BUCKET",
      messagingSenderId: "PASTE_YOUR_SENDER_ID",
      appId: "PASTE_YOUR_APP_ID"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, getDoc, getDocs, onSnapshot, query, where, orderBy, limit, runTransaction, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    // === Util ===
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function toast(msg){ const el = $('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=> el.classList.remove('show'), 1800); }
    function escapeText(t){ return (t||'').replace(/[&<>\"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[s])); }
    async function sha256Hex(str){ const enc = new TextEncoder().encode(str); const buf = await crypto.subtle.digest('SHA-256', enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }

    // === State ===
    const state = {
      tab: 'food',
      uid: null,
      items: { food: [], game: [], todo: [] },
      likedSet: new Set(),
      unsub: { food: null, game: null, todo: null, likes: null },
    };

    // === Render ===
    function render(){
      $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab===state.tab));
      $('#curTab').textContent = '현재 탭: ' + (state.tab==='food'?'먹거리': state.tab==='game'?'게임': state.tab==='todo'?'할일':'순위');

      const isRank = state.tab === 'rank';
      $('#composer').style.display = isRank ? 'none' : 'block';
      $('#list').style.display = isRank ? 'none' : 'flex';
      $('#rank').style.display = isRank ? 'block' : 'none';

      if(!isRank){
        const arr = [...state.items[state.tab]];
        arr.sort((a,b)=> (b.heart - a.heart) || (a.ts?.toMillis?.() ?? a.ts) - (b.ts?.toMillis?.() ?? b.ts));
        const list = $('#list'); list.innerHTML = '';
        arr.forEach(item => list.appendChild(renderItem(item)));
      } else {
        renderRank();
      }
    }

    function renderItem(item){
      const wrap = document.createElement('div');
      wrap.className = 'item clickable';
      wrap.dataset.id = item.id;

      const toprow = document.createElement('div');
      toprow.className = 'toprow';

      const txt = document.createElement('div');
      txt.className = 'txt';
      txt.textContent = item.text;

      const actions = document.createElement('div'); actions.className='actions';

      const heart = document.createElement('button');
      heart.className='heart';
      const liked = state.likedSet.has(item.id);
      heart.dataset.liked = liked ? 'true' : 'false';
      heart.innerHTML = liked ? `💜 <b>${item.heart||0}</b>` : `❤️ <b>${item.heart||0}</b>`;
      heart.setAttribute('aria-label','하트');
      heart.addEventListener('click', (e)=>{ e.stopPropagation(); toggleLike(item); });

      const del = document.createElement('button');
      del.className='del'; del.innerHTML = '🗑️ 삭제';
      del.addEventListener('click', async (e)=>{ e.stopPropagation(); await tryDelete(item); });

      actions.append(heart, del);
      toprow.append(txt, actions);

      const desc = document.createElement('div');
      desc.className = 'desc';
      desc.textContent = item.desc ? item.desc : '설명이 없어요';

      wrap.append(toprow, desc);
      wrap.addEventListener('click', ()=> wrap.classList.toggle('open'));
      return wrap;
    }

    function renderRank(){
      const topHTML = (arr)=> [...arr].sort((a,b)=> (b.heart - a.heart) || (a.ts?.toMillis?.() ?? a.ts) - (b.ts?.toMillis?.() ?? b.ts))
        .slice(0,3)
        .map((x,i)=>`<div style="display:flex;align-items:center;gap:10px; margin:6px 0;">
          <div style="width:26px;height:26px;display:grid;place-items:center;border-radius:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-weight:800;">${i+1}</div>
          <div style="flex:1;font-weight:700;">${escapeText(x.text)}</div>
          <div style="opacity:.9;">❤️ ${x.heart||0}</div>
        </div>`).join('') || '<div style="color:var(--muted)">아직 항목이 없어요.</div>';
      $('#r-food').innerHTML = topHTML(state.items.food);
      $('#r-game').innerHTML = topHTML(state.items.game);
      $('#r-todo').innerHTML = topHTML(state.items.todo);
    }

    // === Firestore Listeners ===
    function listenCategory(cat){
      if(state.unsub[cat]) state.unsub[cat]();
      const q = query(collection(db,'items'), where('category','==',cat));
      state.unsub[cat] = onSnapshot(q, snap => {
        const arr = [];
        snap.forEach(docu => arr.push({ id: docu.id, ...docu.data() }));
        state.items[cat] = arr;
        render();
      });
    }

    function listenLikes(){
      if(state.unsub.likes) state.unsub.likes();
      const q = query(collection(db,'likes'), where('uid','==', state.uid));
      state.unsub.likes = onSnapshot(q, snap => {
        const set = new Set();
        snap.forEach(d => set.add(d.data().itemId));
        state.likedSet = set; render();
      });
    }

    // === Actions ===
    async function addItem(){
      const input = $('#newText');
      const descEl = $('#newDesc');
      const pinEl = $('#pin');
      const text = (input.value||'').trim();
      const desc = (descEl.value||'').trim();
      const pin = (pinEl.value||'').trim();
      if(!text){ toast('제목을 입력해주세요'); return; }
      if(!/^\d{4}$/.test(pin)){ toast('4자리 비밀번호를 입력하세요'); return; }
      const pinHash = await sha256Hex(pin);
      const cat = state.tab; // food|game|todo
      await addDoc(collection(db,'items'), { text, desc, pinHash, heart: 0, ts: serverTimestamp(), category: cat });
      input.value=''; descEl.value=''; pinEl.value='';
      toast('등록 완료!');
    }

    async function toggleLike(item){
      if(!state.uid){ toast('연결 중... 잠시 뒤 시도해주세요'); return; }
      const likeId = `${item.id}_${state.uid}`;
      const likeRef = doc(db,'likes', likeId);
      const itemRef = doc(db,'items', item.id);
      try{
        await runTransaction(db, async (trx)=>{
          const likeSnap = await trx.get(likeRef);
          const itemSnap = await trx.get(itemRef);
          if(!itemSnap.exists()) return;
          const currentHeart = itemSnap.data().heart || 0;
          if(likeSnap.exists()){
            trx.delete(likeRef);
            trx.update(itemRef, { heart: Math.max(0, currentHeart - 1) });
          } else {
            trx.set(likeRef, { itemId: item.id, uid: state.uid, ts: serverTimestamp() });
            trx.update(itemRef, { heart: currentHeart + 1 });
          }
        });
      } catch(e){ console.error(e); toast('하트를 반영하지 못했어요. 다시 시도해주세요.'); }
    }

    async function tryDelete(item){
      const pinTry = prompt('해당 항목 비밀번호 (4자리)');
      if(pinTry===null) return;
      if(!/^\d{4}$/.test(pinTry)) { toast('4자리 숫자를 입력하세요'); return; }
      const hash = await sha256Hex(pinTry);
      if(hash !== item.pinHash){ toast('비밀번호가 올바르지 않습니다'); return; }
      // delete likes of this item
      const likesSnap = await getDocs(query(collection(db,'likes'), where('itemId','==', item.id)));
      const deletes = likesSnap.docs.map(d=> deleteDoc(d.ref));
      await Promise.allSettled(deletes);
      await deleteDoc(doc(db,'items', item.id));
      toast('삭제 완료');
    }

    // === Wiring ===
    $('#titleBtn').addEventListener('click', ()=> $('#hipModal').classList.add('open'));
    $('#hipModal').addEventListener('click', ()=> $('#hipModal').classList.remove('open'));

    $('#addBtn').addEventListener('click', addItem);
    $('#newText').addEventListener('keydown', (e)=>{ if(e.key==='Enter') addItem(); });
    $('#pin').addEventListener('keydown', (e)=>{ if(e.key==='Enter') addItem(); });

    $$('.tab').forEach(t=> t.addEventListener('click', ()=>{ state.tab = t.dataset.tab; render(); }));

    // Start listeners for all categories so 순위 탭도 항상 최신
    listenCategory('food'); listenCategory('game'); listenCategory('todo');

    // Auth → 좋아요 상태 동기화
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user)=>{
      if(user){ state.uid = user.uid; listenLikes(); }
    });

    // Initial paint
    render();
  </script>
</body>
</html>
